<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Bot de WhatsApp</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f2f5; margin: 20px; }
        .container { text-align: center; padding: 30px; background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 600px; margin-bottom: 20px; }
        .table-container { width: 100%; max-width: 800px; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #1c1e21; }
        input, button { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        button { background-color: #1877f2; color: white; cursor: pointer; }
        #clearDbButton { background-color: #dc3545; } /* Botón rojo para limpiar */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f5f6f7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Panel de Control</h1>
        <form id="sendForm">
            <!-- Formulario de envío -->
        </form>
        <div id="status"></div>
        <h2>Log de Respuestas en Vivo:</h2>
        <div id="responses" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 6px;"></div>
    </div>

    <div class="table-container">
        <h2>Números Confirmados</h2>
        <button id="viewConfirmedButton">Actualizar Lista</button>
        <button id="clearDbButton">Limpiar Lista de Confirmados</button>
        <table id="confirmedTable">
            <thead><tr><th>Número Confirmado</th><th>Código</th><th>Fecha</th></tr></thead>
            <tbody><!-- Los datos se insertarán aquí --></tbody>
        </table>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const sendForm = document.getElementById('sendForm');
        const viewConfirmedButton = document.getElementById('viewConfirmedButton');
        const clearDbButton = document.getElementById('clearDbButton');
        const confirmedTableBody = document.querySelector('#confirmedTable tbody');
        const socket = io();

        // Lógica para el botón de limpiar
        clearDbButton.addEventListener('click', () => {
            if (confirm("¿Estás seguro de que quieres borrar TODOS los números confirmados? Esta acción no se puede deshacer.")) {
                console.log("Enviando orden para limpiar la base de datos...");
                socket.emit('limpiar-confirmados');
            }
        });

        // El resto del script es igual, pero lo pego completo por si acaso
        const formHtml = `
            <div><label for="destinationNumber">Número de Destino:</label><input type="text" id="destinationNumber" name="destinationNumber" required></div>
            <div><label for="imageFile">Seleccionar Imagen:</label><input type="file" id="imageFile" name="imageFile" accept="image/*" required></div>
            <button type="submit" id="submitButton">Enviar Secuencia</button>`;
        sendForm.innerHTML = formHtml;
        
        const submitButton = document.getElementById('submitButton');
        const statusDiv = document.getElementById('status');
        const responsesDiv = document.getElementById('responses');
        
        sendForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(sendForm);
            submitButton.disabled = true;
            statusDiv.textContent = 'Procesando...';
            const response = await fetch('/iniciar-secuencia', { method: 'POST', body: formData });
            const result = await response.json();
            statusDiv.textContent = result.message;
            submitButton.disabled = false;
        });

        viewConfirmedButton.addEventListener('click', () => {
            socket.emit('ver-confirmados');
        });
        
        socket.on('datos-confirmados', (data) => {
            confirmedTableBody.innerHTML = '';
            if (data.length === 0) {
                confirmedTableBody.innerHTML = '<tr><td colspan="3">No hay números confirmados.</td></tr>';
            } else {
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    const formattedDate = new Date(row.confirmado_en).toLocaleString('es-ES');
                    tr.innerHTML = `<td>${row.numero_confirmado}</td><td>${row.mensaje_confirmacion}</td><td>${formattedDate}</td>`;
                    confirmedTableBody.appendChild(tr);
                });
            }
        });
        
        socket.on('nueva-respuesta', (data) => {
            const el = document.createElement('div');
            el.innerHTML = `<b>${data.from}:</b> ${data.text}`;
            responsesDiv.prepend(el);
        });
    </script>
</body>
</html>